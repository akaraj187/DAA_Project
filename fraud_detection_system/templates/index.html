<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FraudGuard AI | Advanced Detection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Local overrides & Layout */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease;
        }

        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #scanning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            z-index: 900;
            display: none;
            /* Flex when active */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }

        /* Scanner animation */
        .scanner {
            width: 300px;
            height: 300px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            position: relative;
            animation: pulseRing 2s infinite;
        }

        .scanner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 150px;
            background: linear-gradient(to bottom, var(--primary), transparent);
            transform-origin: top left;
            animation: scanRotate 2s linear infinite;
        }

        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4);
            }

            70% {
                box-shadow: 0 0 0 50px transparent;
            }

            100% {
                box-shadow: 0 0 0 0 transparent;
            }
        }

        @keyframes scanRotate {
            to {
                transform: rotate(360deg);
            }
        }

        .scan-text {
            margin-top: 20px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
            letter-spacing: 2px;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        #app-container {
            display: flex;
            height: 100vh;
            opacity: 0;
            transition: opacity 1s ease;
        }

        #app-container.visible {
            opacity: 1;
        }

        /* Sidebar & Layout */
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        .user-nav {
            position: absolute;
            top: 20px;
            right: 40px;
            z-index: 10;
            font-size: 14px;
        }

        .user-nav a {
            color: var(--text-muted);
            text-decoration: none;
            margin-left: 15px;
            transition: color 0.2s;
        }

        .user-nav a:hover {
            color: var(--primary);
        }

        .user-nav .username {
            color: var(--text-main);
            font-weight: 600;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(2px);
        }

        .history-item.active {
            border-color: var(--primary);
            background: rgba(56, 189, 248, 0.1);
        }

        .history-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .history-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .count-badge.sus {
            color: var(--danger);
            font-weight: bold;
        }

        .clear-history-btn {
            margin-top: auto;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .status-clean {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-fraud {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        tr.suspicious td {
            background: rgba(239, 68, 68, 0.02);
        }
    </style>
</head>

<body>

    <!-- Scanning Overlay -->
    <div id="scanning-overlay">
        <div class="scanner"></div>
        <div class="scan-text">SCANNING TRANSACTIONS...</div>
    </div>

    <!-- Welcome Overlay -->
    <div id="welcome-screen">
        <div class="welcome-content animate-in" style="text-align: center;">
            <h1 class="gradient-text" style="font-size: 48px; margin-bottom: 10px;">FraudGuard AI</h1>
            <p style="color: var(--text-muted); margin-bottom: 40px;">Advanced Transaction Analysis System</p>

            <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 40px;">
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; width: 140px;">
                    <div style="font-size: 24px; color: var(--primary); margin-bottom: 8px;">C++</div>
                    <div style="font-size: 12px; color: var(--text-muted);">High Performance Engine</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; width: 140px;">
                    <div style="font-size: 24px; color: #a855f7; margin-bottom: 8px;">AI</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Pattern Recognition</div>
                </div>
            </div>

            {% if current_user.is_authenticated %}
            <button class="primary-btn enter-prompt" onclick="enterApp()">Enter System</button>
            {% else %}
            <div style="display: flex; gap: 10px; justify-content: center;">
                <a href="{{ url_for('login') }}" class="primary-btn" style="text-decoration: none;">Login</a>
                <a href="{{ url_for('register') }}" class="primary-btn"
                    style="text-decoration: none; background: transparent; border: 1px solid var(--border-color);">Register</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container">
        <div class="user-nav">
            {% if current_user.is_authenticated %}
            <span class="username">{{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}">Logout</a>
            {% else %}
            <a href="{{ url_for('login') }}">Login</a>
            <a href="{{ url_for('register') }}">Register</a>
            {% endif %}
        </div>
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>FraudGuard</h1>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">
                Hybrid C++ Analysis Engine
            </div>

            <h2>History</h2>
            <div class="history-list" id="historyList">
                <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 13px;">
                    No history found
                </div>
            </div>

            <button class="clear-history-btn" onclick="clearHistory()">Clear History</button>
        </div>

        <!-- Content -->
        <div class="main-content">
            <div class="glass-card">
                <h2>New Analysis</h2>
                <textarea id="transactionInput"
                    placeholder="Enter transactions (ID,Amount,Description)...&#10;1001,500,Normal Payment&#10;2002,9999,Offshore unknown"></textarea>
                <button class="primary-btn" onclick="analyzeTransactions()" id="analyzeBtn">
                    Run Detection Engine
                </button>
            </div>

            <div id="resultsSection" style="display: none; animation: fadeIn 0.5s ease;">
                <div class="glass-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Analysis Results</h2>
                        <div id="statsBadge"
                            style="font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 12px;">
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Detection Logic</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Welcome Screen Logic ---
        function enterApp() {
            const welcome = document.getElementById('welcome-screen');
            const app = document.getElementById('app-container');

            welcome.classList.add('hidden');
            app.classList.add('visible');

            // Remove from DOM after animation helps performance
            setTimeout(() => {
                welcome.style.display = 'none';
            }, 1000);
        }

        // Listen for Enter key
        document.addEventListener('keydown', function (event) {
            const welcome = document.getElementById('welcome-screen');
            // Only allow enter if authenticated (button exists)
            const enterBtn = document.querySelector('button.enter-prompt');
            if (event.key === 'Enter' && !welcome.classList.contains('hidden') && enterBtn) {
                enterApp();
            }
        });


        // --- Main App Logic ---

        const currentUsername = "{{ current_user.username if current_user.is_authenticated else 'guest' }}";
        const STORAGE_KEY = `fraud_guard_history_${currentUsername}`;
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        renderHistory();

        async function analyzeTransactions() {
            const inputEl = document.getElementById('transactionInput');
            const btn = document.getElementById('analyzeBtn');
            const inputData = inputEl.value;

            if (!inputData.trim()) {
                alert("Please enter transaction data.");
                return;
            }

            btn.innerHTML = 'Executing...';
            btn.disabled = true;

            // Show scanning overlay
            const overlay = document.getElementById('scanning-overlay');
            overlay.style.display = 'flex';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.opacity = '1', 10);

            try {
                // Fake delay to show off animation (User requested "animated" feel)
                await new Promise(r => setTimeout(r, 1500));

                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: inputData })
                });

                if (response.status === 401) {
                    alert("Session expired. Please login again.");
                    window.location.href = "{{ url_for('login') }}";
                    return;
                }

                if (!response.ok) throw new Error(await response.text());
                const results = await response.json();

                addToHistory(inputData, results);
                renderResults(results);

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                // Fade out overlay
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 300);

                btn.innerHTML = 'Run Detection Engine';
                btn.disabled = false;
            }
        }

        function renderResults(results) {
            const section = document.getElementById('resultsSection');
            const tbody = document.querySelector('#resultsTable tbody');
            const stats = document.getElementById('statsBadge');

            tbody.innerHTML = '';
            section.style.display = 'block';

            let fraudCount = 0;
            results.forEach((t, index) => {
                if (t.is_suspicious) fraudCount++;

                // Staggered Animation
                const tr = document.createElement('tr');
                tr.style.animation = `fadeInUp 0.3s ease forwards ${index * 0.05}s`;
                tr.style.opacity = '0'; // start hidden
                tr.className = t.is_suspicious ? 'suspicious' : '';

                tr.innerHTML = `
                    <td style="font-family: 'JetBrains Mono', monospace; font-weight: 600;">#${t.id}</td>
                    <td>$${t.amount.toLocaleString()}</td>
                    <td>${t.description}</td>
                    <td>
                        <span class="status-badge ${t.is_suspicious ? 'status-fraud' : 'status-clean'}">
                            ${t.is_suspicious ? 'DETECTED' : 'SAFE'}
                        </span>
                    </td>
                    <td style="color: var(--text-muted); font-size: 13px;">${t.reason || '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            stats.innerText = `Found ${fraudCount} suspicious transactions out of ${results.length} total.`;
        }

        function addToHistory(input, results) {
            const fraudCount = results.filter(r => r.is_suspicious).length;
            const newItem = {
                id: Date.now(),
                timestamp: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString(),
                input: input,
                results: results,
                fraudCount: fraudCount,
                total: results.length
            };

            history.unshift(newItem);
            if (history.length > 50) history.pop();

            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '';

            if (history.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 13px;">No history found</div>';
                return;
            }

            history.forEach(item => {
                const el = document.createElement('div');
                el.className = 'history-item';
                el.onclick = () => loadHistoryItem(item);

                el.innerHTML = `
                    <div class="history-time">${item.date} ${item.timestamp}</div>
                    <div class="history-stats">
                        <span>Items: ${item.total}</span>
                        <span class="count-badge ${item.fraudCount > 0 ? 'sus' : ''}">${item.fraudCount} Detected</span>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function loadHistoryItem(item) {
            document.getElementById('transactionInput').value = item.input;
            renderResults(item.results);
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
        }

        function clearHistory() {
            if (confirm('Clear all history?')) {
                history = [];
                localStorage.removeItem(STORAGE_KEY);
                renderHistory();
            }
        }
    </script>
</body>

</html>